function scanValue(){var n=d3.timeParse("%m/%d/%Y");data.forEach(function(t){dictClass.indexOf(t.class)<0&&dictClass.push(t.class);dictOrg.indexOf(t.org)<0&&dictOrg.push(t.org);dictOrg_type.indexOf(t.org_type)<0&&dictOrg_type.push(t.org_type);dictPclass.indexOf(t.pclass)<0&&dictPclass.push(t.pclass);dictStatus.indexOf(t.status)<0&&dictStatus.push(t.status);dictOwner.indexOf(t.owner)<0&&dictOwner.push(t.owner);dictGrant.indexOf(t.grant)<0&&dictGrant.push(t.grant);t.startY=n(t.start).getFullYear();t.endY=n(t.end).getFullYear();t.startY<startFrom&&(startFrom=t.startY);t.startY>startTo&&(startTo=t.startY);t.endY<endFrom&&(endFrom=t.endY);t.endY>endTo&&(endTo=t.endY)});dictClass.sort();dictOrg.sort();dictOrg_type.sort();dictPclass.sort();dictStatus.sort();dictOwner.sort();dictGrant.sort();initFilter(dictOwner,$("#divFilters ul[data-id='owner']"));initFilter(dictPclass,$("#divFilters ul[data-id='pclass']"));initFilter(dictOrg_type,$("#divFilters ul[data-id='org_type']"));initFilter(dictStatus,$("#divFilters ul[data-id='status']"));initFilter(dictGrant,$("#divFilters ul[data-id='grant']"));$("#divFilters ul[data-id='pclass'] > li").each(function(){d3.select(this).append("span").attr("class","color").style("background-color",pclassColor(d3.select(this).select("span").text()))})}function initFilter(n,t){var i="";n.forEach(function(n){i+="<li class='active'><span>"+(n==null||n==""?"[empty]":n)+"<\/span><a>[remove]<\/a><\/li>"});t.html(i)}function refreshChart(){var n,o;if(container.selectAll("*").remove(),$("#divFilters ul[data-id='pclass'] .color").hide(),n=$("#divDisplayModes .btn.active").attr("data-id"),n=="trend"){$("#divFilters ul[data-id='pclass'] .color").show();drawLines();return}var s=[],t=[],i=[],u=1e6,f=0,h=n=="pclass"?dictPclass:n=="class"?dictClass:dictOrg;if(h.forEach(function(n){t[n]=0;i[n]=0}),n=="pclass"?chartData.forEach(function(n){t[n.pclass]+=parseFloat(n.total);i[n.pclass]++}):n=="class"?chartData.forEach(function(n){t[n.class]+=parseFloat(n.total);i[n.class]++}):chartData.forEach(function(n){t[n.org]+=parseFloat(n.total);i[n.org]++}),$.each(h,function(n,r){var e=i[r];e!=0&&(s.push({id:n,name:r==null||r==""?"[empty]":r,value:t[r],records:e}),e<u&&(u=e),e>f&&(f=e))}),$("#divDisplayModes > div").show(),s.length!=0){$("#spanRecords").html(u+" - "+f);var e=Math.min($container.width(),$container.height()),c=d3.scaleLinear().domain([Math.sqrt(u),Math.sqrt(f)]).interpolate(d3.interpolateHslLong).range(["#007DB4","#FFA600"]),l=d3.pack().size([e,e]).padding(1),a=d3.hierarchy({children:s}).sum(function(n){return n.value}),v=container.append("svg").attr("width",e).attr("height",e).attr("class","bubble"),r=v.selectAll(".node").data(l(a).leaves()).enter().append("g").attr("class","node").attr("opacity",0).attr("transform",function(n){return"translate("+n.x+","+n.y+")"});r.attr("data-id",function(n){return n.data.name}).append("circle").attr("id",function(n){return"node"+n.data.id}).attr("r",function(n){return n.r}).style("fill",function(n){return c(Math.sqrt(n.data.records))});r.append("clipPath").attr("id",function(n){return"clip"+n.data.id}).append("use").attr("xlink:href",function(n){return"#node"+n.data.id});r.filter(function(n){return n.r>=40}).append("text").attr("clip-path",function(n){return"url(#clip"+n.data.id+")"}).selectAll("tspan").data(function(n){var t=n.data.name.split(/(?=[A-Z][^A-Z])/g);return t.push("Â£"+d3.format(".2s")(n.data.value)),t}).enter().append("tspan").attr("x",0).attr("y",function(n,t,i){return 20+(t-i.length/2-.5)*15}).text(function(n){return n});o=container.append("div").attr("class","tooltip").attr("style","display: none;");r.on("mouseover",function(n){var t=d3.mouse(container.node());o.html("<label>"+n.data.name+"<\/label><br/>Number of Grants: "+n.data.records+"<br/>Total grant value: "+d3.format(",.2f")(n.data.value)).style("left",t[0]+20+"px").style("top",t[1]-10+"px").style("display","inline")}).on("mouseout",function(){o.style("display","none")}).on("mousemove",function(){var n=d3.mouse(container.node());o.style("left",n[0]+20+"px").style("top",n[1]-10+"px")}).on("click",function(){var u=$("#divDisplayModes .btn.active").attr("data-id"),r=d3.select(this).attr("data-id"),t,i,n;for(t=u=="pclass"?chartData.filter(function(n){return n.pclass==r}):u=="class"?chartData.filter(function(n){return n.class==r}):chartData.filter(function(n){return n.org==r}),t.sort(function(n,t){return t.total-n.total}),$("#divDialog .title").html("Top grant"),i="<table>",i+="<thead><tr><th>Project title<\/th><th>Organisation name<\/th><th>Year of start date<\/th><th>Total grant value<\/th><\/tr><\/thead>",i+="<tbody>",n=0;n<5&&n<t.length;n++)i+="<tr><td>"+t[n].title+"<\/td><td>"+t[n].org+"<\/td><td>"+t[n].startY+"<\/td><td>"+d3.format(",.2f")(t[n].total)+"<\/td><\/tr>";i+="<\/tbody>";i+="<\/table>";$("#divDialog .body").html(i);$("#divDialog").addClass("active")});r.transition().duration(1e3).attr("opacity",1)}}function drawLines(){var t=[],r=[],u=[],h,o,c;if(dictPclass.forEach(function(n){r[n]=[];u[n]=[]}),chartData.forEach(function(n){r[n.pclass][n.startY]==null?(r[n.pclass][n.startY]=parseFloat(n.total),u[n.pclass][n.startY]=1):(r[n.pclass][n.startY]+=parseFloat(n.total),u[n.pclass][n.startY]++)}),h=Math.min(startTo,(new Date).getFullYear()),$.each(dictPclass,function(n,i){var o=u[i],e,f;if(o.length!=0){for(e={id:n,name:i==null||i==""?"[empty]":i,years:[]},f=2006;f<=h;f++)r[i][f]!=null&&e.years.push({year:f,value:r[i][f],records:u[i][f]});t.push(e)}}),$("#divDisplayModes > div").hide(),t.length!=0){var n={top:50,right:50,bottom:80,left:60},s=$container.width()-n.left-n.right,i=$container.height()-n.top-n.bottom,f=d3.scaleLinear().range([0,s]),e=d3.scaleLinear().range([i,0]),y=d3.line().x(function(n){return f(n.year)}).y(function(n){return e(n.value)});f.domain([d3.min(t,function(n){return d3.min(n.years,function(n){return n.year})}),d3.max(t,function(n){return d3.max(n.years,function(n){return n.year})})]);e.domain([d3.min(t,function(n){return d3.min(n.years,function(n){return n.value})}),d3.max(t,function(n){return d3.max(n.years,function(n){return n.value})})]);o=container.append("svg").attr("width",$container.width()).attr("height",$container.height()).append("g").attr("transform","translate("+n.left+","+n.top+")");o.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+i+")").call(d3.axisBottom(f).tickFormat(d3.format("d"))).append("text").attr("x",n.left+s/2-40).attr("y",40).attr("fill","#000").text("Year of start date");o.append("g").attr("class","axis axis--y").call(d3.axisLeft(e).tickFormat(d3.format(".2s"))).append("text").attr("transform","rotate(-90)").attr("y",-45).attr("fill","#000").text("Total Grant Value");c=o.selectAll(".line").data(t).enter().append("g").attr("class","line");c.append("path").attr("d",function(n){return y(n.years)}).style("stroke",function(n){return pclassColor(n.name)});var l=container.append("div").attr("class","vertical").style("height",i+"px").style("top",n.top+"px").style("left",n.left+"px"),a=container.append("div").attr("class","tooltip").attr("style","display: none; width: 200px;"),v=container.append("div").attr("class","focus").attr("style","display: none;");container.select("svg").on("mousemove",function(){var y=d3.mouse(o.node()),u=y[0],h=y[1],c,w,b;if(u<0||u>s){l.style("display","none");a.style("display","none");v.style("display","none");return}h<0&&(h=0);h>i&&(h=i);l.style("display","inline").style("left",u+n.left+"px");var k=Math.round(f.invert(u)),p=e.invert(h),r=null;t.forEach(function(n){n.years.forEach(function(t){t.year==k&&(r==null||Math.abs(r.year.value-p)>Math.abs(t.value-p))&&(r={item:n,year:t})})});r!=null&&(c="<label style='color: "+pclassColor(r.item.name)+"'>"+r.item.name+"<\/label>",c+="<br/><span>Year of start date: "+r.year.year+"<\/span>",c+="<br/><span>Number of Grants: "+r.year.records+"<\/span>",c+="<br/><span>Total grant value: "+d3.format(",.2f")(r.year.value)+"<\/span>",w=s-u<220?u+n.left-230:u+n.left+10,b=(i-h<100?i-100:h)+n.top,a.html(c).style("left",w+"px").style("top",b+"px").style("display","inline"),v.style("background-color",pclassColor(r.item.name)).style("left",Math.round(f(r.year.year)+n.left-5)+"px").style("top",Math.round(e(r.year.value)+n.top-5)+"px").style("display","inline"))})}}function refreshFilter(){var t=$("#divFilters ul[data-id='owner']").find("li.active > span").map(function(){return $(this).text()}).get(),n=$("#divFilters ul[data-id='pclass']").find("li.active > span").map(function(){return $(this).text()}).get(),i=$("#divFilters ul[data-id='org_type']").find("li.active > span").map(function(){return $(this).text()}).get(),r=$("#divFilters ul[data-id='status']").find("li.active > span").map(function(){return $(this).text()}).get(),u=$("#divFilters ul[data-id='grant']").find("li.active > span").map(function(){return $(this).text()}).get(),f;n.indexOf("[empty]")>=0&&(f=n.indexOf("[empty]"),n[f]="");chartData=[];var e=t.length==dictOwner.length,o=n.length==dictPclass.length,s=i.length==dictOrg_type.length,h=r.length==dictStatus.length,c=u.length==dictGrant.length;data.forEach(function(f){!e&&t.indexOf(f.owner)<0||!o&&n.indexOf(f.pclass)<0||!s&&i.indexOf(f.org_type)<0||!h&&r.indexOf(f.status)<0||!c&&u.indexOf(f.grant)<0||chartData.push(f)});refreshChart()}var container=d3.select("#divContainer"),$container=$("#divContainer"),data,chartData,dictClass=[],dictOrg=[],dictOrg_type=[],dictPclass=[],dictStatus=[],dictOwner=[],dictGrant=[],startFrom=1e6,startTo=0,endFrom=1e6,endTo=0,pclassColor=d3.scaleOrdinal(d3.schemeCategory20);$(document).ready(function(){$("#divDisplayModes .btn").click(function(){$("#divDisplayModes .btn.active").removeClass("active");$(this).addClass("active");refreshChart()});$("#divFilters ul").on("click","a",function(){return $(this).parent().hasClass("active")&&($(this).parent().removeClass("active"),refreshFilter()),!1});$("#divFilters ul").on("click","li",function(){return $(this).closest("ul").find("li.active").removeClass("active"),$(this).addClass("active"),refreshFilter(),!1});$("#divFilters label").on("click","a",function(){return $(this).parent().next().find("li").addClass("active"),refreshFilter(),!1});$("#divDialog").click(function(){$("#divDialog").removeClass("active")});$("#divDialog .dialog-content").click(function(){return!1});$("#divDialog .dialog-close").click(function(){return $("#divDialog").removeClass("active"),!1});d3.csv("data/PhysicsFunding2.csv",function(n){data=n;chartData=n;scanValue();$("#divDisplayModes .btn").first().click()})});
/*
//# sourceMappingURL=index3.min.js.map
*/